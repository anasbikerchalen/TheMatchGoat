<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Georgia vs Bulgaria — Preview</title>

  <!-- cache-bust while developing -->
  <link rel="stylesheet" href="../styles.css?v=3" />

  <style>
    /* Page-only styles (no cover rules here) */
    .match-hero { padding: 28px 0 10px; }
    .match-hero h1 { margin: 0 0 6px; font-size: clamp(22px, 4.5vw, 30px); }
    .muted { color: var(--muted); }
    .content-card {
      background: linear-gradient(180deg, var(--card) 0%, var(--card-2) 100%);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .stack { display: grid; gap: 16px; }
  </style>

  <link rel="icon" href="../thematchgoat-icon.png" type="image/png">
  <link rel="apple-touch-icon" href="../thematchgoat-icon.png">
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand">
        <img class="brand-logo" src="../thematchgoat-icon.png" alt="The Match Goat logo" width="28" height="28" />
        <a href="../index.html" class="brand-name" style="text-decoration:none;color:#fff">The Match Goat</a>
      </div>
    </div>
  </header>

  <!-- Cover: full-width, true 16:9, no cropping (uses global CSS) -->
  <section class="match-cover-wrap">
    <div class="container container-cover">
      <img
        class="match-cover"
        src="../images/covers/georgia-vs-bulgaria.png"
        alt="Georgia vs Bulgaria match cover"
        loading="eager"
        decoding="async"
        fetchpriority="high"
      />
    </div>
  </section>

  <main>
    <section class="match-hero">
      <div class="container">
        <h1>Georgia vs Bulgaria</h1>
        <p class="muted">UEFA World Cup Qualifying • TBA</p>
      </div>
    </section>

    <section>
      <div class="container stack">
        <div class="content-card">
          <h2 style="margin-top:0">Overview</h2>
          <p>Write your match overview here...</p>
        </div>
      </div>
    </section>

    <!-- Predictions block -->
    <section id="predictions-ge-vs-bg" class="container">
      <style>
        #predictions-ge-vs-bg .header-line {
          display: flex; flex-wrap: wrap; gap: .5rem; align-items: baseline;
          justify-content: space-between; color: var(--text);
        }
        #predictions-ge-vs-bg .meta { color: var(--muted); font-size: .9rem; }
        #predictions-ge-vs-bg table { width: 100%; border-collapse: collapse; }
        #predictions-ge-vs-bg th, #predictions-ge-vs-bg td {
          padding: .6rem .7rem; border-bottom: 1px solid var(--border); text-align: left;
        }
        #predictions-ge-vs-bg thead th {
          color: var(--muted); font-weight: 600; font-size: .9rem; position: sticky; top: 0; background: var(--card);
          z-index: 1;
        }
        #predictions-ge-vs-bg tbody tr:hover td { background: rgba(255,255,255,.03); }
        #predictions-ge-vs-bg .nowrap { white-space: nowrap; }
        #predictions-ge-vs-bg .muted { color: var(--muted); }
        #predictions-ge-vs-bg .badge {
          display:inline-flex; align-items:center; gap:.5rem;
          font-size:.9rem; padding:.35rem .6rem; border:1px solid var(--border); border-left-width:6px; border-radius:.4rem;
          background: var(--card-2); color: var(--text);
        }
        #predictions-ge-vs-bg .legend { display:flex; gap:1rem; align-items:center; flex-wrap: wrap; }
        #predictions-ge-vs-bg .dot { width:.75rem; height:.75rem; border-radius:2px; display:inline-block; }
        #predictions-ge-vs-bg .dot.home { background: var(--accent); }
        #predictions-ge-vs-bg .dot.draw { background: var(--muted); }
        #predictions-ge-vs-bg .dot.away { background: var(--accent-2); }
        #predictions-ge-vs-bg .best { background: rgba(255,255,255,.04); font-weight: 600; }
        #predictions-ge-vs-bg .best-home { box-shadow: inset 3px 0 0 var(--accent); }
        #predictions-ge-vs-bg .best-draw { box-shadow: inset 3px 0 0 var(--muted); }
        #predictions-ge-vs-bg .best-away { box-shadow: inset 3px 0 0 var(--accent-2); }
        #predictions-ge-vs-bg .link-btn { color: var(--accent); text-decoration: none; }
        #predictions-ge-vs-bg .cards { display:grid; gap:1rem; }
        @media (min-width: 860px) { #predictions-ge-vs-bg .cards { grid-template-columns: 1fr; } }
      </style>

      <div class="cards">
        <div class="content-card stack" style="padding:1rem;">
          <div class="header-line">
            <div>
              <strong>Georgia vs Bulgaria</strong>
              <span class="meta">• UEFA World Cup Qualifying • 2025-09-07 13:00 UTC</span>
            </div>
          </div>

          <div style="overflow:auto; margin-top:.5rem;">
            <table class="pred-table" aria-label="Predictions from sources with probabilities, odds, and picks">
              <thead>
                <tr>
                  <th>Source</th>
                  <th>Pick</th>
                  <th class="nowrap">Home %</th>
                  <th class="nowrap">Draw %</th>
                  <th class="nowrap">Away %</th>
                  <th>Odds</th>
                  <th class="nowrap">Published</th>
                  <th>Link</th>
                </tr>
              </thead>
              <tbody id="predictions-table-body"></tbody>
            </table>
          </div>
        </div>

        <div class="content-card stack" style="padding:1rem;">
          <div style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
            <div id="consensus-badge" class="badge" aria-live="polite">Consensus: — (—%)</div>
            <div class="legend" aria-hidden="true">
              <span><span class="dot home"></span> Home</span>
              <span><span class="dot draw"></span> Draw</span>
              <span><span class="dot away"></span> Away</span>
            </div>
          </div>
          <div style="padding-top:.5rem; height: 160px;">
            <canvas id="consensusChart" aria-label="Consensus probabilities horizontal bar chart for Home, Draw, Away" role="img"></canvas>
          </div>
        </div>
      </div>

      <script>
        // 1) Raw data from pasted JSON
        const predictionsData = {
          "match": "Georgia vs Bulgaria",
          "competition": "UEFA World Cup Qualifying",
          "kickoff": "2025-09-07 13:00 UTC",
          "sources": [
            {
              "name": "Tips.GG",
              "url": "https://tips.gg/article/georgia-vs-bulgaria-07-09-2025/",
              "type": "analytics",
              "published": "2025-09-05",
              "pick": { "outcome": "Home", "scoreline": null },
              "probabilities": { "home": 0.685, "draw": 0.233, "away": 0.137 },
              "odds": { "format": "decimal", "home": 1.46, "draw": 4.30, "away": 7.30 },
              "rationale": "Georgia’s superior form and fortress-like home record give them a 65 % win probability.",
              "region": "Germany"
            },
            {
              "name": "PredictZ",
              "url": "https://www.predictz.com/us/picks/international/world-cup-2026-qualifying/1119471/",
              "type": "tips",
              "published": "2025-09-05",
              "pick": { "outcome": "Home", "scoreline": "2-1" },
              "probabilities": { "home": 0.714, "draw": 0.222, "away": 0.118 },
              "odds": { "format": "decimal", "home": 1.40, "draw": 4.50, "away": 8.50 },
              "rationale": "Model lists Georgia at –250, expecting a narrow home victory with both teams scoring.",
              "region": "United Kingdom"
            },
            {
              "name": "WinDrawWin",
              "url": "https://www.windrawwin.com/us/picks/world-cup-qualifying/georgia-v-bulgaria/806939/",
              "type": "tips",
              "published": "2025-09-05",
              "pick": { "outcome": "Home", "scoreline": "2-1" },
              "probabilities": { "home": 0.510, "draw": 0.310, "away": 0.180 },
              "odds": { "format": "decimal", "home": 1.40, "draw": 4.50, "away": 8.50 },
              "rationale": "Site expects BTTS, over 2.5 goals and a Georgia win; home choice backed by majority of users.",
              "region": "United Kingdom"
            },
            {
              "name": "FootballPredictions.com",
              "url": "https://footballpredictions.com/footballpredictions/world-cup-predictions/georgia-vs-bulgaria-prediction-07-09-2025/",
              "type": "tips",
              "published": "2025-09-05",
              "pick": { "outcome": "Home", "scoreline": "2-0" },
              "probabilities": null,
              "odds": null,
              "rationale": "Georgia expected to ‘go all guns blazing’ after Turkey loss; Bulgaria ‘failed to impress’ vs Spain.",
              "region": null
            },
            {
              "name": "BettingExpert",
              "url": "https://www.bettingexpert.com/football/bulgaria-vs-georgia",
              "type": "tips",
              "published": "2025-09-04",
              "pick": { "outcome": "Home", "scoreline": null },
              "probabilities": null,
              "odds": { "format": "decimal", "home": 1.44, "draw": null, "away": null },
              "rationale": "Multiple tipsters cite Georgia’s attacking edge and Bulgaria’s lack of quality since 1994.",
              "region": "Denmark"
            }
          ],
          "consensus": {
            "method": "avg probabilities",
            "home": 0.64,
            "draw": 0.26,
            "away": 0.15,
            "top_pick": "Home"
          },
          "citations": ["turn3view0","turn14view0","turn27view0","turn2view0","turn24view0"],
          "checked_at": "2025-09-06T00:00:00Z"
        };

        // 2) Utilities
        const $ = (sel, root=document) => root.querySelector(sel);
        const fmtPct = (v) => {
          if (v == null || isNaN(v)) return "—";
          const pct = v * 100;
          const decimals = (pct > 0 && pct < 1) ? 1 : 0;
          return `${pct.toFixed(decimals)}%`;
        };
        const fmtOdds = (odds) => {
          if (!odds) return "—";
          const fx = (n) => (typeof n === 'number') ? n.toFixed(2).replace(/\.00$/,'') : "—";
          return `H: ${fx(odds.home)}  D: ${fx(odds.draw)}  A: ${fx(odds.away)}`;
        };
        const nearZero = (n) => Math.abs(n) < 1e-6;

        function normalizeTriple(p) {
          if (!p) return null;
          let {home, draw, away} = p;
          if ([home, draw, away].some(v => typeof v !== 'number' || isNaN(v))) return null;
          const sum = home + draw + away;
          if (nearZero(sum)) return null;
          return { home: home / sum, draw: draw / sum, away: away / sum };
        }
        function impliedFromDecimalOdds(odds) {
          if (!odds || odds.format !== 'decimal') return { type: 'none' };
          const inv = (o) => (typeof o === 'number' && o > 0) ? (1 / o) : null;
          const ih = inv(odds.home), id = inv(odds.draw), ia = inv(odds.away);
          const haveAll = [ih,id,ia].every(v => typeof v === 'number');
          if (haveAll) {
            const sum = ih + id + ia;
            if (sum > 0) return { type: 'oddsTriple', home: ih/sum, draw: id/sum, away: ia/sum };
          }
          return { type: 'oddsPartial', home: ih, draw: id, away: ia };
        }
        function extractRowProbs(src) {
          if (src.probabilities && typeof src.probabilities === 'object') {
            const norm = normalizeTriple(src.probabilities);
            if (norm) return { type: 'prob', ...norm };
          }
          const implied = impliedFromDecimalOdds(src.odds);
          if (implied.type === 'oddsTriple' || implied.type === 'oddsPartial') return implied;
          return { type: 'none', home: null, draw: null, away: null };
        }
        function topKeyInRow({home, draw, away}) {
          const entries = [
            ['home', typeof home === 'number' ? home : -1],
            ['draw', typeof draw === 'number' ? draw : -1],
            ['away', typeof away === 'number' ? away : -1],
          ];
          entries.sort((a,b) => b[1] - a[1]);
          return entries[0][1] >= 0 ? entries[0][0] : null;
        }

        // 3) Render table
        function renderTable() {
          const tbody = document.getElementById("predictions-table-body");
          if (!tbody) return;
          tbody.innerHTML = "";
          predictionsData.sources.forEach(src => {
            const probs = extractRowProbs(src);
            const tr = document.createElement('tr');

            const tdSource = document.createElement('td');
            tdSource.textContent = src.name || "—";

            const tdPick = document.createElement('td');
            const pick = src?.pick?.outcome || "—";
            const score = src?.pick?.scoreline ? ` ${src.pick.scoreline}` : "";
            tdPick.textContent = pick !== "—" ? `${pick}${score}` : "—";

            const tdH = document.createElement('td'); tdH.className = "nowrap"; tdH.textContent = fmtPct(probs.home);
            const tdD = document.createElement('td'); tdD.className = "nowrap"; tdD.textContent = fmtPct(probs.draw);
            const tdA = document.createElement('td'); tdA.className = "nowrap"; tdA.textContent = fmtPct(probs.away);

            const tdOdds = document.createElement('td'); tdOdds.textContent = fmtOdds(src.odds);

            const tdPub = document.createElement('td'); tdPub.className = "nowrap muted"; tdPub.textContent = src.published || "—";

            const tdLink = document.createElement('td');
            if (src.url) {
              const a = document.createElement('a');
              a.href = src.url; a.target = "_blank"; a.rel = "noopener noreferrer";
              a.className = "link-btn";
              a.setAttribute('aria-label', `Open source ${src.name}`);
              a.textContent = "Open";
              tdLink.appendChild(a);
            } else { tdLink.textContent = "—"; }

            tr.append(tdSource, tdPick, tdH, tdD, tdA, tdOdds, tdPub, tdLink);
            tbody.appendChild(tr);

            const bestKey = topKeyInRow(probs);
            if (bestKey) {
              const map = { home: tdH, draw: tdD, away: tdA };
              map[bestKey].classList.add('best', `best-${bestKey}`);
            }
          });
        }

        // 4) Compute consensus
        function computeConsensus() {
          const extracted = predictionsData.sources.map(extractRowProbs);
          const probTriples = extracted.filter(x => x.type === 'prob' || x.type === 'oddsTriple');
          let method = "avg probabilities";
          let consensus = { home: 0, draw: 0, away: 0 };

          if (probTriples.length > 0) {
            const sums = probTriples.reduce((acc, p) => {
              acc.home += p.home; acc.draw += p.draw; acc.away += p.away; return acc;
            }, {home:0, draw:0, away:0});
            consensus.home = sums.home / probTriples.length;
            consensus.draw = sums.draw / probTriples.length;
            consensus.away = sums.away / probTriples.length;
          } else {
            method = "vote share";
            const votes = { home: 0, draw: 0, away: 0 };
            predictionsData.sources.forEach(src => {
              const pick = src?.pick?.outcome;
              if (pick === "Home") votes.home += 1;
              else if (pick === "Draw") votes.draw += 1;
              else if (pick === "Away") votes.away += 1;
            });
            const totalVotes = votes.home + votes.draw + votes.away;
            if (totalVotes > 0) {
              consensus.home = votes.home / totalVotes;
              consensus.draw = votes.draw / totalVotes;
              consensus.away = votes.away / totalVotes;
            }
          }

          const sum = consensus.home + consensus.draw + consensus.away;
          if (!nearZero(sum) && Math.abs(sum - 1) > 1e-3) {
            consensus = { home: consensus.home / sum, draw: consensus.draw / sum, away: consensus.away / sum };
          }

          return { method, consensus };
        }

        // 5) Chart rendering
        function resolveVarColor(varName) {
          const el = document.createElement('span');
          el.style.color = `var(${varName})`;
          document.body.appendChild(el);
          const rgb = getComputedStyle(el).color || 'rgb(0,0,0)';
          document.body.removeChild(el);
          return rgb;
        }
        function toRgba(rgb, alpha) {
          const m = rgb.match(/rgba?KATEX_INLINE_OPEN\s*(\d+),\s*(\d+),\s*(\d+)/i);
          if (!m) return rgb;
          return `rgba(${m[1]}, ${m[2]}, ${m[3]}, ${alpha})`;
        }
        function updateConsensusBadge(topKey, topPct) {
          const badge = document.getElementById("consensus-badge");
          if (!badge) return;
          const colorVar = topKey === 'home' ? '--accent' : (topKey === 'draw' ? '--muted' : '--accent-2');
          badge.style.borderLeftColor = `var(${colorVar})`;
          const label = topKey === 'home' ? 'Home' : (topKey === 'draw' ? 'Draw' : 'Away');
          badge.textContent = `Consensus: ${label} (${Math.round(topPct*100)}%)`;
          badge.setAttribute('title', 'Top overall consensus outcome');
        }
        async function loadChartJS() {
          if (window.Chart) return;
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = "https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js";
            s.async = true;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        async function renderChart(consensus) {
          await loadChartJS();
          const canvas = document.getElementById('consensusChart');
          if (!canvas) return;
          const existing = window.Chart.getChart(canvas);
          if (existing) existing.destroy();

          const labels = ['Home', 'Draw', 'Away'];
          const values = [consensus.home, consensus.draw, consensus.away].map(v => Math.max(0, v) * 100);

          const cHome = resolveVarColor('--accent');
          const cDraw = resolveVarColor('--muted');
          const cAway = resolveVarColor('--accent-2');

          const baseColors = [cHome, cDraw, cAway];
          const maxIdx = values.indexOf(Math.max(...values));
          const bgColors = baseColors.map((c, i) => toRgba(c, i === maxIdx ? 0.9 : 0.25));
          const borderColors = baseColors.map((c, i) => toRgba(c, i === maxIdx ? 1 : 0.6));
          const borderWidths = baseColors.map((_, i) => i === maxIdx ? 2 : 1);

          const ctx = canvas.getContext('2d');
          new window.Chart(ctx, {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: 'Consensus %',
                data: values,
                backgroundColor: bgColors,
                borderColor: borderColors,
                borderWidth: borderWidths,
                borderRadius: 6,
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--muted') || '#9aa0a6',
                    callback: (val) => `${val}%`
                  },
                  grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border') || 'rgba(255,255,255,.08)' }
                },
                y: {
                  ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text') || '#e5e7eb' },
                  grid: { display: false }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: { label: (ctx) => `${ctx.formattedValue}%` }
                }
              },
              animation: { duration: 300 }
            }
          });

          const keys = ['home','draw','away'];
          updateConsensusBadge(keys[maxIdx], values[maxIdx]/100);
        }

        // 6) Init
        (function init() {
          renderTable();
          const { consensus } = computeConsensus();
          renderChart(consensus);
        })();
      </script>
    </section>
  </main>

  <footer class="site-footer">
    <div class="container">
      <p>© <span id="year"></span> The Match Goat. All rights reserved.</p>
    </div>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
  </script>
</body>
</html>